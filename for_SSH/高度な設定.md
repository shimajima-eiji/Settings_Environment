# 環境解説
説明のためここでは、

- sshサーバーのログインユーザー: `ssh_server`
  - ログインユーザーには必ずパスワードを設定すること
- sshサーバーのIP: `192.168.1.1`

とする。

## 前提知識・ヒント
ファイル作業の場所に注意する。

- クライアント: `~/.ssh/config`を操作する
- サーバー: `/etc/ssh/sshd_config`を操作する

間違えやすいので注意。

### [クライアント側作業]クライアント側の接続を容易にする
この後の作業で楽にするため、`~/.ssh/config`を作成し、簡単にログインできるようにしておく。

```
mkdir -p ~/.ssh
vi ~/.ssh/config
```

編集内容は以下。

```
Host (任意名)
        HostName 192.168.1.1
        User ssh_server
```

このようにしておくと、`ssh (任意名)`で接続できる。  
この後のクライアント作業は全て`~/.ssh/config`を編集し、`ssh (任意名)`を実施するだけになる。

## [簡単]sshポートを22から変更する
1. サーバー側
2. クライアント側

今後もssh作業の基本形になるので、この流れを意識していく。

### [サーバー側作業]sshd_configのPortを変更する
`sudo vi /etc/ssh/sshd_config`を実施し、以下を設定する。

```
Port 任意指定
# Port 22
```

`sudo service ssh restart`を忘れずに。

### [クライアント側作業]configのPortを追加する
`ssh (任意名) -p 任意指定`で接続できる。  
-pはポートを指定するオプションだが、使わなくてもログインできるようにする。

`vi ~/.ssh/config`で編集。内容は以下の通り。

```
Host (任意名)
        HostName 192.168.1.1
        User ssh_server
        Port 指定に合わせる
```

これで`ssh (任意名)`で接続できる。

## [応用]パスワード認証方式から鍵認証方式に切り替える
この辺りから、どのコマンドをサーバー or クライアントで実行するのか分かりにくくなる。

1. クライアントに設定する秘密鍵をscpで渡す
2. サーバーを鍵認証に切り替える
3. sshキーでログインする

### 1. [クライアント側作業]クライアントに設定する秘密鍵をscpで渡す
```
scp (任意名):/etc/ssh/ssh_host_○○_key ~/.ssh/
# もしパーミッションの問題がある場合は、別の場所にcpした方がいいかもしれない。
```

一応、サーバー側でもできるが、コマンドを動かすためにクライアント側にもsshサーバーを設定する必要があるのでおすすめしない。  
また、一時的とはいえ秘密鍵をクラウドに置くのもおすすめしない。

### 2. [サーバー側作業]サーバーを鍵認証に切り替える
一番手っ取り早いコマンドは、

```
mkdir -p ~/.ssh
cat /etc/ssh/ssh_host_○○_key.pub >>~/.ssh/authorized_keys

vi /etc/ssh/sshd_config
# PasswordAuthentication noにする
```

最後に`sudo service ssh restart`を忘れずに。

#### 補足: 鍵の種類
セキュリティ面も考えると、おすすめはssh_host_ed25519_key.pubを使う。  
対になる秘密鍵`ssh_host_ed25519_key`を何らかの方法でクライアントに渡してクライアント側の設定をすればOK。

### 3. [クライアント側作業]sshキーでログインする
`ssh (任意名) -i ~/.ssh/ssh_host_○○_key`でも接続できる。  
が、これもポート同様configに入れられる。

`vi ~/.ssh/config`で編集。内容は以下の通り。

```
Host (任意名)
        HostName 192.168.1.1
        User ssh_server
        IdentityFile ~/.ssh/ssh_host_○○_key

        # 先のポート設定もしているなら、以下も入れておく
        Port 指定に合わせる
```

念の為、パーミッションを記す。

```
~/.ssh
├── config: 600
└── ssh_host_○○_key: 400
```

`ssh (任意名)`で接続できるようになっている。
